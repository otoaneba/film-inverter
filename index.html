<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Color Negative Film Inverter - Convert Film Scans Online</title>
  <meta name="description" content="Easily convert color negative film scans to positives with our free online tool. Remove orange masks, invert colors, and adjust RGB levels.">
  <meta name="keywords" content="color negative inverter, film scan converter, remove orange mask, film photography">
  <meta name="author" content="Your Name">
  <link rel="canonical" href="https://film-inverter.vercel.app">
  <!-- Open Graph Tags -->
  <meta property="og:title" content="Color Negative Film Inverter">
  <meta property="og:description" content="Convert color negative film scans to positives with this free online tool.">
  <meta property="og:image" content="https://film-inverter.vercel.app/assets/og-image.png">
  <meta property="og:url" content="https://film-inverter.vercel.app">
  <meta property="og:type" content="website">
  <!-- Twitter Card Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Color Negative Film Inverter">
  <meta name="twitter:description" content="Convert color negative film scans to positives with this free online tool.">
  <meta name="twitter:image" content="https://film-inverter.vercel.app/assets/og-image.png">
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Color Negative Film Inverter",
    "description": "A free online tool to convert color negative film scans to positive images by removing orange masks, inverting colors, and adjusting RGB levels.",
    "url": "https://film-inverter.vercel.app",
    "applicationCategory": "Photography",
    "operatingSystem": "Web"
  }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">
  <h1 class="text-3xl font-bold mb-6">Color Negative Film Inverter</h1>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl">
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Step 1: Upload Your Color Negative Scan</h2>
      <p class="text-sm text-gray-600 mb-2">Select a high-quality scan (JPEG or PNG).</p>
      <input type="file" id="imageInput" accept="image/*" class="p-2 border rounded">
    </div>
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <canvas id="imageCanvas" class="w-full border"></canvas>
      </div>
      <div class="flex-1 space-y-4">
        <div>
          <h2 class="text-lg font-semibold">Step 2: Remove Orange Mask</h2>
          <p class="text-sm text-gray-600">Click on a bright spot or the edge of the film to set white balance.</p>
          <div class="flex gap-4 mt-2">
            <img src="assets/example-border1.png" alt="Example film border for white balance" class="w-[150px] h-[100px] object-contain cursor-pointer" onclick="openModal('assets/example-border1.png')">
            <img src="assets/example-border2.png" alt="Example film border for white balance" class="w-[150px] h-[100px] object-contain cursor-pointer" onclick="openModal('assets/example-border2.png')">
          </div>
          <p class="text-xs text-gray-500 mt-1">Example photos showing bright spots and edges of film. Click to enlarge.</p>
          <button id="resetWhiteBalance" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 opacity-50 cursor-not-allowed" disabled>Reset White Balance</button>
        </div>
        <div>
          <h2 class="text-lg font-semibold">Step 3: Invert Colors</h2>
          <button id="invertButton" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 opacity-50 cursor-not-allowed" disabled>Invert Image</button>
        </div>
        <div>
          <h2 class="text-lg font-semibold">Step 4: Adjust RGB Levels</h2>
          <div class="space-y-2">
            <div>
              <label class="block text-sm">Red Black Point: <span id="redBlackValue">0</span></label>
              <input type="range" id="redBlack" min="0" max="255" value="0" class="w-full" disabled>
            </div>
            <div>
              <label class="block text-sm">Red White Point: <span id="redWhiteValue">255</span></label>
              <input type="range" id="redWhite" min="0" max="255" value="255" class="w-full" disabled>
            </div>
            <div>
              <label class="block text-sm">Green Black Point: <span id="greenBlackValue">0</span></label>
              <input type="range" id="greenBlack" min="0" max="255" value="0" class="w-full" disabled>
            </div>
            <div>
              <label class="block text-sm">Green White Point: <span id="greenWhiteValue">255</span></label>
              <input type="range" id="greenWhite" min="0" max="255" value="255" class="w-full" disabled>
            </div>
            <div>
              <label class="block text-sm">Blue Black Point: <span id="blueBlackValue">0</span></label>
              <input type="range" id="blueBlack" min="0" max="255" value="0" class="w-full" disabled>
            </div>
            <div>
              <label class="block text-sm">Blue White Point: <span id="blueWhiteValue">255</span></label>
              <input type="range" id="blueWhite" min="0" max="255" value="255" class="w-full" disabled>
            </div>
            <button id="resetLevels" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 opacity-50 cursor-not-allowed" disabled>Reset Levels</button>
          </div>
        </div>
        <div>
          <h2 class="text-lg font-semibold">Step 5: Download</h2>
          <a id="downloadButton" class="inline-block px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 opacity-50 cursor-not-allowed" download="inverted_image.png" disabled>Download Image</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Ko-fi Button -->
  <div class="mt-6 text-center">
    <p class="text-sm text-gray-600 mb-2">Enjoying this tool? Support its development!</p>
    <a href="https://ko-fi.com/naotoabe" target="_blank" class="inline-block px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Support on Ko-fi
      <img src="assets/logomarkLogo.png" alt="Ko-fi" class="inline-block w-4 h-4 ml-2">
    </a>
  </div>

  <!-- Modal for enlarged images -->
  <div id="imageModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden" role="dialog" aria-label="Enlarged example image">
    <div class="bg-white p-4 rounded-lg max-w-2xl w-full mx-4">
      <div class="flex justify-end">
        <button id="closeModal" class="text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center" aria-label="Close modal">âœ•</button>
      </div>
      <img id="modalImage" src="" alt="Enlarged example film border" class="w-full max-h-[400px] object-contain mt-2">
    </div>
  </div>

  <script>
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    let originalImageData = null;
    let currentImageData = null;
    let whiteBalance = { r: 1, g: 1, b: 1 };
    let levels = {
      red: { black: 0, white: 255 },
      green: { black: 0, white: 255 },
      blue: { black: 0, white: 255 }
    };
    let isInverted = false;

    // Modal handling
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeModalButton = document.getElementById('closeModal');

    function openModal(imageSrc) {
      modalImage.src = imageSrc;
      modal.classList.remove('hidden');
      closeModalButton.focus();
      document.addEventListener('keydown', handleEscape);
    }

    function closeModal() {
      modal.classList.add('hidden');
      modalImage.src = '';
      document.removeEventListener('keydown', handleEscape);
    }

    function handleEscape(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    }

    closeModalButton.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Draw placeholder text on canvas
    function drawPlaceholder() {
      canvas.width = 500;
      canvas.height = 300;
      ctx.fillStyle = '#e5e7eb';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#4b5563';
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Upload an image to begin', canvas.width / 2, canvas.height / 2);
    }
    drawPlaceholder();

    // Enable controls
    function enableControls() {
      document.getElementById('resetWhiteBalance').disabled = false;
      document.getElementById('resetWhiteBalance').classList.remove('opacity-50', 'cursor-not-allowed');
      document.getElementById('invertButton').disabled = false;
      document.getElementById('invertButton').classList.remove('opacity-50', 'cursor-not-allowed');
      const downloadButton = document.getElementById('downloadButton');
      downloadButton.removeAttribute('disabled');
      downloadButton.classList.remove('opacity-50', 'cursor-not-allowed');
      downloadButton.classList.add('pointer-events-auto');
      ['redBlack', 'redWhite', 'greenBlack', 'greenWhite', 'blueBlack', 'blueWhite', 'resetLevels'].forEach(id => {
        const element = document.getElementById(id);
        element.disabled = false;
        element.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }

    // Load image
    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          currentImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          enableControls();
          updateImage();
          updateDownloadLink();
        };
        img.src = URL.createObjectURL(file);
      }
    });

    // Sample white balance
    canvas.addEventListener('click', (e) => {
      if (!originalImageData) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
      const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
      const index = (y * canvas.width + x) * 4;
      const r = originalImageData.data[index];
      const g = originalImageData.data[index + 1];
      const b = originalImageData.data[index + 2];
      whiteBalance.r = r > 0 ? 255 / r : 1;
      whiteBalance.g = g > 0 ? 255 / g : 1;
      whiteBalance.b = b > 0 ? 255 / b : 1;
      updateImage();
    });

    // Reset white balance
    document.getElementById('resetWhiteBalance').addEventListener('click', () => {
      whiteBalance = { r: 1, g: 1, b: 1 };
      updateImage();
    });

    // Invert image
    document.getElementById('invertButton').addEventListener('click', () => {
      isInverted = !isInverted;
      updateImage();
    });

    // Update levels
    const updateLevel = (channel, type, value) => {
      levels[channel][type] = parseInt(value);
      document.getElementById(`${channel}${type.charAt(0).toUpperCase() + type.slice(1)}Value`).textContent = value;
      updateImage();
    };

    ['red', 'green', 'blue'].forEach(channel => {
      ['black', 'white'].forEach(type => {
        const input = document.getElementById(`${channel}${type.charAt(0).toUpperCase() + type.slice(1)}`);
        input.addEventListener('input', () => updateLevel(channel, type, input.value));
      });
    });

    // Reset levels
    document.getElementById('resetLevels').addEventListener('click', () => {
      levels = {
        red: { black: 0, white: 255 },
        green: { black: 0, white: 255 },
        blue: { black: 0, white: 255 }
      };
      ['red', 'green', 'blue'].forEach(channel => {
        ['black', 'white'].forEach(type => {
          const input = document.getElementById(`${channel}${type.charAt(0).toUpperCase() + type.slice(1)}`);
          input.value = type === 'black' ? 0 : 255;
          document.getElementById(`${channel}${type.charAt(0).toUpperCase() + type.slice(1)}Value`).textContent = input.value;
        });
      });
      updateImage();
    });

    // Update image
    function updateImage() {
      if (!originalImageData) return;
      const data = new Uint8ClampedArray(originalImageData.data);
      for (let i = 0; i < data.length; i += 4) {
        let r = data[i];
        let g = data[i + 1];
        let b = data[i + 2];

        // Step 1: Apply white balance
        r = Math.min(255, r * whiteBalance.r);
        g = Math.min(255, g * whiteBalance.g);
        b = Math.min(255, b * whiteBalance.b);

        // Step 2: Invert if needed
        if (isInverted) {
          r = 255 - r;
          g = 255 - g;
          b = 255 - b;
        }

        // Step 3: Apply levels
        r = applyLevels(r, levels.red.black, levels.red.white);
        g = applyLevels(g, levels.green.black, levels.green.white);
        b = applyLevels(b, levels.blue.black, levels.blue.white);

        data[i] = r;
        data[i + 1] = g;
        data[i + 2] = b;
      }
      currentImageData = new ImageData(data, canvas.width, canvas.height);
      ctx.putImageData(currentImageData, 0, 0);
      updateDownloadLink();
    }

    // Apply levels adjustment
    function applyLevels(value, black, white) {
      if (white <= black) return value;
      return Math.min(255, Math.max(0, ((value - black) * 255) / (white - black)));
    }

    // Update download link
    function updateDownloadLink() {
      const downloadButton = document.getElementById('downloadButton');
      try {
        const dataUrl = canvas.toDataURL('image/png');
        downloadButton.href = dataUrl;
        console.log('Download link updated:', dataUrl.substring(0, 50) + '...');
      } catch (e) {
        console.error('Error updating download link:', e);
      }
    }
  </script>
</body>
</html>